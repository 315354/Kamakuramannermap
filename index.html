<script>
// 強調用の変数
let highlightedMarker = null;

// 店舗色マップ
const storeColors = ["blue","purple","skyblue"];
stores.forEach((store,i)=>store.color=storeColors[i]);

function showTime(time){
  currentTime=time;
  currentMarkers.forEach(m=>map.removeLayer(m));
  currentMarkers=[];

  // スポット
  spots.forEach((spot,index)=>{
    const level=congestionLevels[time][index];
    const marker=L.circleMarker([spot.lat,spot.lng],{
      radius:15, fillColor:getColor(level), color:getColor(level), fillOpacity:0.9, weight:1
    }).addTo(map);

    marker.on('click',()=>{
      // 前回の強調解除
      if(highlightedMarker) highlightedMarker.setStyle({radius:highlightedMarker.options._originalRadius, weight:1});
      // 強調
      marker.setStyle({radius:25, weight:3});
      highlightedMarker=marker;
      // マナー表示
      document.getElementById('tips').innerHTML=`<b>${spot.name}</b><br>混雑度:${level}<br>マナー:<br>${spot.tips[currentLanguage]}`;
    });

    // 保存元のサイズ
    marker.options._originalRadius = 15;

    const label=L.divIcon({
      className:'marker-label',
      html:spot.name.replace("スポット",""),
      iconSize:[24,24], iconAnchor:[12,12]
    });
    const labelMarker=L.marker([spot.lat,spot.lng],{icon:label}).addTo(map);

    currentMarkers.push(marker,labelMarker);
  });

  // 店舗
  stores.forEach((store)=>{
    const marker=L.circleMarker([store.lat,store.lng],{
      radius:18, fillColor:store.color, color:store.color, fillOpacity:0.9, weight:1
    }).addTo(map);

    marker.on('click',()=>{
      if(highlightedMarker) highlightedMarker.setStyle({radius:highlightedMarker.options._originalRadius, weight:1});
      marker.setStyle({radius:28, weight:3});
      highlightedMarker=marker;
      document.getElementById('tips').innerHTML=`<b>${store.name}</b><br>マナー:<br>${store.tips[currentLanguage]}`;
    });

    marker.options._originalRadius = 18;
    currentMarkers.push(marker);
  });
}
</script>
